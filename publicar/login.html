<!DOCTYPE html>
<html lang="es-CO">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Iniciar sesi√≥n ‚Äî Conciencia Digital</title>
  <meta name="description" content="Iniciar sesi√≥n ‚Äî Conciencia Digital">
  <link rel="icon" href="favicon.ico">
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <div class="container">
    <header>
      <div class="brand">
        <div class="logo">CD</div>
        <div class="brand-text">
          <strong>Conciencia Digital</strong><br>
          <small class="muted">Inicia sesi√≥n</small>
        </div>
      </div>
      <nav class="nav">
        <a href="index.html">Inicio</a>
        <a href="register.html">Registro</a>
      </nav>
    </header>

    <main class="main-form">
      <section class="form-card" aria-labelledby="form-title">
        <h1 id="form-title">Iniciar sesi√≥n</h1>
        <p class="muted">Accede con tu correo y contrase√±a.</p>

        <form id="loginForm" novalidate>
          <!-- Email -->
          <div class="field-group">
            <label for="email">Correo electr√≥nico <span class="required">*</span></label>
            <input id="email" name="email" type="email" placeholder="tucorreo@ejemplo.com" required>
          </div>

          <!-- Password -->
          <div class="field-group">
            <label for="password">Contrase√±a <span class="required">*</span></label>
            <div class="password-wrap">
              <input id="password" name="password" type="password" minlength="8" placeholder="Contrase√±a" required>
              <button type="button" class="show-pass" aria-label="Mostrar contrase√±a">üëÅÔ∏è</button>
            </div>
          </div>

          <!-- Recordarme / Olvid√© -->
          <div class="field-group checkbox-group">
            <label class="checkbox">
              <input type="checkbox" id="remember">
              <span>Recordarme</span>
            </label>
            <div style="margin-top:8px">
              <a href="recover.html" class="btn link">Olvid√© mi contrase√±a</a>
            </div>
          </div>

          <div id="formMessage" aria-live="polite" class="form-message"></div>

          <!-- Buttons -->
          <div class="form-actions">
            <button type="submit" class="btn primary">Iniciar sesi√≥n</button>
            <a href="register.html" class="btn link">¬øNo tienes cuenta? Reg√≠strate</a>
          </div>
        </form>
      </section>
    </main>

    <footer>
      <div class="footer-inner">
        <small class="muted">¬© 2025 Conciencia Digital ‚Äî <a href="privacidad.html">Pol√≠tica de privacidad</a></small>
        <a href="contacto.html">Contacto</a>
      </div>
    </footer>
  </div>

  <!-- Scripts -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    const SUPABASE_URL = 'https://gpgxaeynjsvovdzyppoo.supabase.co';
    const SUPABASE_ANON_KEY = 'sb_publishable_HuchtYI9DCe9M70OqefGIg_LM9UDoZm';
    const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // Toggle mostrar contrase√±a
    document.querySelectorAll('.show-pass').forEach(btn => {
      btn.addEventListener('click', () => {
        const input = btn.parentElement.querySelector('input');
        input.type = input.type === 'password' ? 'text' : 'password';
        btn.textContent = input.type === 'password' ? 'üëÅÔ∏è' : 'üôà';
      });
    });

    // Login real con Supabase
    const form = document.getElementById('loginForm');
    const msg = document.getElementById('formMessage');

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      msg.textContent = '';
      msg.className = 'form-message';

      const fd = new FormData(form);
      const email = fd.get('email')?.trim();
      const password = fd.get('password');

      if (!email || !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
        return showError('Ingresa un correo v√°lido.');
      }
      if (!password || password.length < 8) {
        return showError('La contrase√±a debe tener al menos 8 caracteres.');
      }

      try {
        // 1. Login con Supabase
        const { data, error } = await sb.auth.signInWithPassword({ email, password });
        if (error) return showError(error.message);

        // 2. Consulta el rol desde la tabla profiles
        const userId = data.user.id;
        const { data: profile, error: profileError } = await sb
          .from('profiles')
          .select('rol, nombre, id_participantes')
          .eq('id', userId)
          .single();

        if (profileError || !profile) {
          return showError('No se pudo determinar el rol del usuario.');
        }

        // 3. Guardar datos del usuario en localStorage
        localStorage.setItem('userRole', profile.rol);
        localStorage.setItem('userName', profile.nombre);
        localStorage.setItem('userIdParticipantes', profile.id_participantes);

        // 4. Redirige seg√∫n el rol
        showSuccess('Inicio correcto. Redirigiendo...');
        setTimeout(() => {
          if (profile.rol === 'estudiante') {
            window.location.href = 'student_dashboard.html';
          } else if (profile.rol === 'supervisor') {
            window.location.href = 'supervisor_dashboard.html';
          } else if (profile.rol === 'evaluado') {
            window.location.href = 'evaluado_dashboard.html';
          } else {
            window.location.href = 'index.html';
          }
        }, 1000);

      } catch (err) {
        showError('Error al conectar con el servidor.');
      }
    });

    function showError(text) {
      msg.textContent = text;
      msg.classList.add('error');
    }
    function showSuccess(text) {
      msg.textContent = text;
      msg.classList.add('success');
    }
  </script>
</body>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="auth.js"></script>
</html>