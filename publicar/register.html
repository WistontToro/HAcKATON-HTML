<!DOCTYPE html>
<html lang="es-CO">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Registro ‚Äî Conciencia Digital</title>
  <meta name="description" content="Registro de usuarios ‚Äî Conciencia Digital (Estudiante, Supervisor, Evaluado).">
  <link rel="icon" href="favicon.ico">
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <div class="container">
    <header>
      <div class="brand">
        <div class="logo">CD</div>
        <div class="brand-text">
          <strong>Conciencia Digital</strong><br>
          <small class="muted">Registro de usuario</small>
        </div>
      </div>
      <nav class="nav">
        <a href="index.html">Inicio</a>
        <a href="login.html">Iniciar sesi√≥n</a>
      </nav>
    </header>

    <main class="main-form">
      <section class="form-card" aria-labelledby="form-title">
        <h1 id="form-title">Crear cuenta</h1>
        <p class="muted">Selecciona tu rol, la instituci√≥n y completa tus datos para registrarte.</p>

        <form id="registerForm" novalidate>
          <!-- N√∫mero de identificaci√≥n -->
          <div class="field-group">
            <label for="numero_id">N√∫mero de identificaci√≥n <span class="required">*</span></label>
            <input id="numero_id" name="numero_id" type="text" placeholder="C√©dula o Tarjeta de Identidad" required>
          </div>

          <!-- ROLE -->
          <fieldset class="field-group" aria-labelledby="role-legend">
            <legend id="role-legend">Selecciona tu rol <span class="required">*</span></legend>
            <div class="radio-group">
              <label class="radio"><input type="radio" name="role" value="estudiante" required><span>Estudiante</span></label>
              <label class="radio"><input type="radio" name="role" value="supervisor" required><span>Supervisor</span></label>
              <label class="radio"><input type="radio" name="role" value="evaluado" required><span>Evaluado</span></label>
            </div>
          </fieldset>

          <!-- Institution -->
          <div class="field-group">
            <label for="institucion">Instituci√≥n <span class="required">*</span></label>
            <select id="institucion" name="institucion" required>
              <option value="" selected disabled>Selecciona tu instituci√≥n</option>
              <option>Universidad de Nari√±o</option>
              <option>Colegio Nacional</option>
              <option>Instituci√≥n Educativa T√©cnica</option>
              <option>Otra</option>
            </select>
            <input type="text" id="institucion-otra" class="hidden extra-input" placeholder="Especifica la instituci√≥n (si seleccionaste 'Otra')">
          </div>

          <!-- Grado -->
          <div class="field-group">
            <label for="grado">Grado / Nivel (ej. 11¬∞, 3er semestre) <span class="required">*</span></label>
            <input id="grado" name="grado" type="text" placeholder="Ingresa tu grado o nivel" required>
          </div>

          <!-- Nombre completo -->
          <div class="two-col">
            <div class="field-group">
              <label for="nombre">Nombre <span class="required">*</span></label>
              <input id="nombre" name="nombre" type="text" placeholder="Nombre" required>
            </div>
            <div class="field-group">
              <label for="apellidos">Apellidos <span class="required">*</span></label>
              <input id="apellidos" name="apellidos" type="text" placeholder="Apellidos" required>
            </div>
          </div>

          <!-- Email -->
          <div class="field-group">
            <label for="email">Correo electr√≥nico <span class="required">*</span></label>
            <input id="email" name="email" type="email" placeholder="tucorreo@ejemplo.com" required>
          </div>

          <!-- Password -->
          <div class="two-col">
            <div class="field-group">
              <label for="password">Contrase√±a <span class="required">*</span></label>
              <div class="password-wrap">
                <input id="password" name="password" type="password" minlength="8" placeholder="M√≠nimo 8 caracteres" required>
                <button type="button" class="show-pass" aria-label="Mostrar contrase√±a">üëÅÔ∏è</button>
              </div>
            </div>
            <div class="field-group">
              <label for="passwordConfirm">Confirmar contrase√±a <span class="required">*</span></label>
              <input id="passwordConfirm" name="passwordConfirm" type="password" minlength="8" placeholder="Repite la contrase√±a" required>
            </div>
          </div>

          <!-- Terms -->
          <div class="field-group checkbox-group">
            <label class="checkbox">
              <input type="checkbox" id="terms" required>
              <span>Acepto la <a href="privacidad.html">Pol√≠tica de privacidad</a> y los <a href="terminos.html">T√©rminos</a>.</span>
            </label>
          </div>

          <div id="formMessage" aria-live="polite" class="form-message"></div>

          <!-- Buttons -->
          <div class="form-actions">
            <button type="submit" class="btn primary">Crear cuenta</button>
            <a href="login.html" class="btn link">¬øYa tienes cuenta? Inicia sesi√≥n</a>
          </div>
        </form>
      </section>
    </main>

    <footer>
      <div class="footer-inner">
        <small class="muted">¬© 2025 Conciencia Digital ‚Äî <a href="privacidad.html">Pol√≠tica de privacidad</a></small>
        <a href="contacto.html">Contacto</a>
      </div>
    </footer>
  </div>

  <!-- Scripts: primero supabase, luego auth.js (helpers), luego script del registro -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="auth.js"></script>
  <script>
    // Registro: usa createProfileForUser desde auth.js
    document.addEventListener('DOMContentLoaded', () => {
      const selectInst = document.getElementById('institucion');
      const instOtra = document.getElementById('institucion-otra');
      const form = document.getElementById('registerForm');
      const msg = document.getElementById('formMessage');

      function showError(text){ if(msg){ msg.textContent = text; msg.classList.add('error'); } else alert(text); }
      function showSuccess(text){ if(msg){ msg.textContent = text; msg.classList.add('success'); } else console.log(text); }
      function validateEmail(email){ return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email); }

      // Mostrar / ocultar input "Otra instituci√≥n"
      if(selectInst){
        selectInst.addEventListener('change', (e) => {
          if (e.target.value === 'Otra') {
            instOtra.classList.remove('hidden');
            instOtra.required = true;
            instOtra.focus();
          } else {
            instOtra.classList.add('hidden');
            instOtra.required = false;
            instOtra.value = '';
          }
        });
      }

      // Manejo submit
      if(!form) return;
      form.addEventListener('submit', async (e) => {
        e.preventDefault();
        if(msg){ msg.textContent = ''; msg.className = 'form-message'; }

        const fd = new FormData(form);
        const numero_id = (fd.get('numero_id') || '').trim();
        const role = fd.get('role');
        const institucion = (fd.get('institucion') === 'Otra' ? fd.get('institucion-otra') : fd.get('institucion')) || '';
        const grado = (fd.get('grado') || '').trim();
        const nombre = (fd.get('nombre') || '').trim();
        const apellidos = (fd.get('apellidos') || '').trim();
        const email = (fd.get('email') || '').trim();
        const password = fd.get('password') || '';
        const passwordConfirm = fd.get('passwordConfirm') || '';
        const terms = document.getElementById('terms').checked;

        if (!numero_id) return showError('Ingresa tu n√∫mero de identificaci√≥n.');
        if (!role) return showError('Selecciona un rol.');
        if (!institucion) return showError('Selecciona o especifica tu instituci√≥n.');
        if (!grado) return showError('Ingresa tu grado o nivel.');
        if (!nombre || !apellidos) return showError('Completa tu nombre y apellidos.');
        if (!email || !validateEmail(email)) return showError('Ingresa un correo v√°lido.');
        if (!password || password.length < 8) return showError('La contrase√±a debe tener al menos 8 caracteres.');
        if (password !== passwordConfirm) return showError('Las contrase√±as no coinciden.');
        if (!terms) return showError('Debes aceptar la Pol√≠tica de privacidad y los T√©rminos.');

        try {
          // 1. Crear usuario en Auth
          const { data, error } = await sb.auth.signUp({ email, password });
          if (error) {
            console.error('signUp error', error);
            return showError(error.message || 'Error registrando usuario.');
          }
          const user = data?.user;
          if(!user) {
            console.error('No se recibi√≥ user en signUp', data);
            return showError('No se pudo crear el usuario. Revisa la consola.');
          }

          // 2. determinamos id_est_ev por rol
          let id_est_ev = null;
          if (role === 'estudiante') id_est_ev = '0000000000';
          else if (role === 'supervisor') id_est_ev = '1111111111';

          // 3. construimos objeto del perfil. Nota: usa "numero_id" (campo del formulario).
          // Si quieres que "id_participantes" sea el mismo que numero_id, a√±√°delo aqu√≠.
          const profileData = {
            numero_id,
            nombre,
            apellidos,
            rol: role,
            institucion,
            grado,
            id_est_ev
          };

          // 4. crear perfil con helper de auth.js
          try {
            await createProfileForUser(user.id, profileData);
          } catch (err) {
            console.error('Profile creation error', err);
            return showError('Error guardando tu perfil. Revisa la consola.');
          }

          showSuccess('Registro correcto. Ahora puedes iniciar sesi√≥n.');
          setTimeout(()=> window.location.href = 'login.html', 1300);

        } catch(err) {
          console.error('Error (registro):', err);
          showError('Error al conectar con el servidor.');
        }
      });
    });
  </script>
</body>
</html>
